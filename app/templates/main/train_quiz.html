{% extends "base.html" %}

{% block title %}Entraînement - {{ quiz.title }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Accueil</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('main.view_quiz', quiz_id=quiz.id) }}">{{ quiz.title }}</a></li>
                    <li class="breadcrumb-item active">Mode Entraînement</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">{{ quiz.title }} - Mode Entraînement</h4>
                </div>
                <div class="card-body">
                    <div id="quiz-container"></div>

                    <div class="progress my-3">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%">
                            0%
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="validate-btn" class="btn btn-success">Valider</button>
                        <button id="next-btn" class="btn btn-primary d-none">Suivant</button>
                        <button id="quit-btn" class="btn btn-danger">Quitter</button>
                    </div>

                    <div class="mt-4 text-center" id="score-display"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const questions = JSON.parse('{{ questions|tojson | safe }}');
    let currentIndex = 0;
    let score = 0;
    let correctAnswers = 0;

    const container = document.getElementById('quiz-container');
    const validateBtn = document.getElementById('validate-btn');
    const nextBtn = document.getElementById('next-btn');
    const quitBtn = document.getElementById('quit-btn');
    const progressBar = document.getElementById('progress-bar');
    const scoreDisplay = document.getElementById('score-display');

    function renderQuestion() {
        const q = questions[currentIndex];
        container.innerHTML = `
            <h5>Question ${currentIndex + 1} sur ${questions.length}</h5>
            <p class="mb-3">${q.text}</p>
            <form id="answer-form">
                ${q.answers_shuffled.map(a => `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="answer" id="answer_${a.id}" value="${a.id}">
                        <label class="form-check-label" for="answer_${a.id}">
                            ${a.text}
                        </label>
                    </div>
                `).join('')}
            </form>
        `;
        progressBar.style.width = `${(currentIndex / questions.length) * 100}%`;
        progressBar.textContent = `${Math.round((currentIndex / questions.length) * 100)}%`;
    }

    function validateAnswer() {
        const selected = document.querySelector('input[name="answer"]:checked');
        if (!selected) {
            alert("Sélectionnez une réponse avant de valider.");
            return;
        }

        const selectedId = parseInt(selected.value);
        const q = questions[currentIndex];
        let isCorrect = false;

        q.answers_shuffled.forEach(a => {
            const label = document.querySelector(`label[for=answer_${a.id}]`);
            if (a.is_correct) {
                label.style.color = 'green';
                label.style.fontWeight = 'bold';
            }
            if (a.id === selectedId && !a.is_correct) {
                label.style.color = 'red';
            }
            if (a.id === selectedId && a.is_correct) {
                isCorrect = true;
            }
        });

        if (isCorrect) {
            score++;
            correctAnswers++;
        }

        validateBtn.classList.add('d-none');
        nextBtn.classList.remove('d-none');
    }

    function nextQuestion() {
        currentIndex++;
        if (currentIndex >= questions.length) {
            showResult();
        } else {
            renderQuestion();
            validateBtn.classList.remove('d-none');
            nextBtn.classList.add('d-none');
        }
    }

    function quitQuiz() {
        if (confirm("Voulez-vous quitter le quiz ? Le score partiel sera affiché.")) {
            showResult();
        }
    }

    function showResult() {
        const answered = questions.slice(0, currentIndex);
        const answers = {};

        answered.forEach((q, index) => {
            const selected = document.querySelector('input[name="answer"]:checked', document.getElementById('quiz-container'));
            if (selected) {
                answers[q.id] = parseInt(selected.value);
            }
        });

        fetch(location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                answers: answers,
                completed: currentIndex >= questions.length
            })
        })
        .then(response => response.json())
        .then(data => {
            container.innerHTML = '';
            validateBtn.classList.add('d-none');
            nextBtn.classList.add('d-none');
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            scoreDisplay.innerHTML = `
                <h4>Résultat ${data.completed ? "final" : "partiel"}</h4>
                <p>Score : ${data.score} bonne(s) réponse(s) sur ${data.total}</p>
                <a href="{{ url_for('main.view_quiz', quiz_id=quiz.id) }}" class="btn btn-outline-secondary mt-3">Retour au quiz</a>
            `;
        });
    }


    validateBtn.addEventListener('click', validateAnswer);
    nextBtn.addEventListener('click', nextQuestion);
    quitBtn.addEventListener('click', quitQuiz);

    renderQuestion();
</script>
{% endblock %}
